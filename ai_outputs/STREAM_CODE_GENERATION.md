# Mobile Agent æµå¼ä»£ç ç”ŸæˆåŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬åŠŸèƒ½å®ç°äº† Mobile Agent æ‰§è¡Œä¸ Auto.js ä»£ç ç”Ÿæˆçš„å®Œæ•´æµå¼å“åº”æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **Agent æ‰§è¡Œæµå¼è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤º Agent çš„æ€è€ƒè¿‡ç¨‹å’ŒåŠ¨ä½œæ‰§è¡Œ
2. **ä»£ç ç”Ÿæˆæµå¼è¾“å‡º**ï¼šåŸºäº Agent history å®æ—¶ç”Ÿæˆ Auto.js è„šæœ¬
3. **Web æ¼”ç¤ºé¡µé¢**ï¼šå¯è§†åŒ–å±•ç¤ºæ•´ä¸ªæµç¨‹
4. **å®Œæ•´çš„ history è®°å½•**ï¼šä¿å­˜å®Œæ•´åŠ¨ä½œå¯¹è±¡ç”¨äºä»£ç ç”Ÿæˆ

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ–‡ä»¶ç»“æ„

```
e:/AgentDroid/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ openai_client.py        [æ–°å»º] é€šç”¨ OpenAI å®¢æˆ·ç«¯
â”‚   â””â”€â”€ code_generator.py       [æ–°å»º] Auto.js ä»£ç ç”Ÿæˆå™¨
â”œâ”€â”€ agent_core.py               [ä¿®æ”¹] history ä¿å­˜å®Œæ•´åŠ¨ä½œå¯¹è±¡
â”œâ”€â”€ main.py                     [ä¿®æ”¹] æ·»åŠ  SSE æµå¼æ¥å£
â””â”€â”€ static/                     [æ–°å»º] Web æ¼”ç¤ºé¡µé¢
    â”œâ”€â”€ index.html              HTML ä¸»é¡µé¢
    â”œâ”€â”€ css/
    â”‚   â””â”€â”€ style.css           æ ·å¼è¡¨
    â””â”€â”€ js/
        â””â”€â”€ stream-client.js    SSE å®¢æˆ·ç«¯
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
python main.py
```

æœåŠ¡å°†åœ¨ `http://localhost:9777` å¯åŠ¨

### 2. è®¿é—® Web é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
http://localhost:9777/
```

### 3. é…ç½®å‚æ•°

åœ¨ Web é¡µé¢ä¸­å¡«å†™ï¼š
- **æŒ‡ä»¤**ï¼šä¾‹å¦‚ "æ‰“å¼€è®¾ç½®"
- **æœ€å¤§æ­¥æ•°**ï¼šAgent æ‰§è¡Œçš„æœ€å¤§æ­¥æ•°ï¼ˆé»˜è®¤ 10ï¼‰
- **Agent æ¨¡å‹**ï¼šç”¨äº Agent çš„æ¨¡å‹ï¼ˆé»˜è®¤ gui-owlï¼‰
- **ä»£ç ç”Ÿæˆæ¨¡å‹**ï¼šç”¨äºç”Ÿæˆä»£ç çš„æ¨¡å‹ï¼ˆé»˜è®¤ gpt-4ï¼‰
- **API Key**ï¼šOpenAI API å¯†é’¥
- **Base URL**ï¼šOpenAI API åŸºç¡€ URL

### 4. å¼€å§‹æ‰§è¡Œ

ç‚¹å‡» **"â–¶ å¼€å§‹æ‰§è¡Œ"** æŒ‰é’®ï¼Œå³å¯ï¼š
1. å®æ—¶è§‚çœ‹ Agent æ‰§è¡Œè¿‡ç¨‹
2. æŸ¥çœ‹ç”Ÿæˆçš„ Auto.js ä»£ç 
3. å¤åˆ¶æˆ–ä¸‹è½½ç”Ÿæˆçš„è„šæœ¬

---

## ğŸ“¡ API æ¥å£

### POST `/run-agent-stream`

æµå¼æ‰§è¡Œ Agent å¹¶ç”Ÿæˆä»£ç 

**è¯·æ±‚ä½“ï¼š**
```json
{
  "instruction": "æ‰“å¼€è®¾ç½®",
  "max_steps": 10,
  "api_key": "your-api-key",
  "base_url": "http://your-api-url",
  "model_name": "gui-owl",
  "codegen_api_key": "optional-codegen-key",
  "codegen_base_url": "optional-codegen-url",
  "codegen_model": "gpt-4"
}
```

**å“åº”ï¼š** SSE (Server-Sent Events) æµ

**äº‹ä»¶ç±»å‹ï¼š**

#### Agent é˜¶æ®µäº‹ä»¶

- `task_init` - ä»»åŠ¡åˆå§‹åŒ–
- `device_connected` - è®¾å¤‡å·²è¿æ¥
- `step_start` - æ­¥éª¤å¼€å§‹
- `screenshot` - æˆªå›¾å®Œæˆ
- `llm_chunk` - LLM æµå¼è¾“å‡ºç‰‡æ®µ
- `llm_complete` - LLM å“åº”å®Œæˆ
- `action_parsed` - åŠ¨ä½œè§£æå®Œæˆ
- `action_executing` - åŠ¨ä½œæ‰§è¡Œä¸­
- `action_completed` - åŠ¨ä½œæ‰§è¡Œå®Œæˆ
- `step_end` - æ­¥éª¤ç»“æŸ
- `task_completed` - ä»»åŠ¡å®Œæˆ

#### ä»£ç ç”Ÿæˆé˜¶æ®µäº‹ä»¶

- `codegen_start` - å¼€å§‹ç”Ÿæˆä»£ç 
- `codegen_chunk` - ä»£ç ç‰‡æ®µ
- `codegen_complete` - ä»£ç ç”Ÿæˆå®Œæˆ

#### é€šç”¨äº‹ä»¶

- `done` - å…¨éƒ¨å®Œæˆ
- `error` - é”™è¯¯ä¿¡æ¯

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### cURL è¯·æ±‚ç¤ºä¾‹

```bash
curl -X POST http://localhost:9777/run-agent-stream \
  -H "Content-Type: application/json" \
  -d '{
    "instruction": "æ‰“å¼€è®¾ç½®",
    "max_steps": 10,
    "api_key": "your-api-key",
    "base_url": "http://your-api-url",
    "model_name": "gui-owl",
    "codegen_model": "gpt-4"
  }'
```

### Python å®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import json

url = "http://localhost:9777/run-agent-stream"
payload = {
    "instruction": "æ‰“å¼€è®¾ç½®",
    "max_steps": 10,
    "api_key": "your-api-key",
    "base_url": "http://your-api-url",
    "model_name": "gui-owl",
    "codegen_model": "gpt-4"
}

with requests.post(url, json=payload, stream=True) as response:
    for line in response.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data: '):
                event = json.loads(line[6:])
                print(f"äº‹ä»¶: {event['event_type']}")
                
                # å¤„ç†ä»£ç ç‰‡æ®µ
                if event['event_type'] == 'codegen_chunk':
                    print(event['data']['chunk'], end='', flush=True)
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. OpenAI å®¢æˆ·ç«¯ (`utils/openai_client.py`)

æä¾›ç»Ÿä¸€çš„ OpenAI API è°ƒç”¨æ¥å£ï¼š

```python
from utils.openai_client import OpenAIClient

client = OpenAIClient(
    api_key="your-key",
    base_url="http://your-url",
    model="gpt-4"
)

# æµå¼è°ƒç”¨
for chunk in client.chat_completion_stream(messages):
    print(chunk, end='', flush=True)
```

**ç‰¹æ€§ï¼š**
- æ”¯æŒåŒæ­¥å’Œæµå¼è°ƒç”¨
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- å®Œæ•´çš„æ—¥å¿—è®°å½•

### 2. ä»£ç ç”Ÿæˆå™¨ (`utils/code_generator.py`)

æ ¹æ® Agent history ç”Ÿæˆ Auto.js è„šæœ¬ï¼š

```python
from utils.code_generator import CodeGenerator

generator = CodeGenerator(
    api_key="your-key",
    base_url="http://your-url",
    model="gpt-4"
)

# æµå¼ç”Ÿæˆä»£ç 
for event in generator.generate_code_stream(
    history=agent_history,
    task_id="task_123",
    instruction="æ‰“å¼€è®¾ç½®",
    status="success"
):
    if event['event_type'] == 'codegen_chunk':
        print(event['data']['chunk'], end='')
```

**ç‰¹æ€§ï¼š**
- ä½¿ç”¨ä¸“ä¸šçš„ Auto.js è„šæœ¬ç”Ÿæˆ Prompt
- æµå¼è¾“å‡ºä»£ç 
- è‡ªåŠ¨æ ¼å¼åŒ– history ä¸ºæ‰€éœ€æ ¼å¼

### 3. History æ ¼å¼

ä¿®æ”¹åçš„ `agent_core.py` ç°åœ¨ä¿å­˜å®Œæ•´çš„åŠ¨ä½œå¯¹è±¡ï¼š

**æ—§æ ¼å¼ï¼ˆä»…æè¿°ï¼‰ï¼š**
```python
["ç‚¹å‡»åæ ‡ [100, 200]", "è¾“å…¥æ–‡æœ¬ hello"]
```

**æ–°æ ¼å¼ï¼ˆå®Œæ•´å¯¹è±¡ï¼‰ï¼š**
```python
[
    {'action': 'click', 'coordinate': [100, 200], 'description': 'ç‚¹å‡»è®¾ç½®å›¾æ ‡'},
    {'action': 'type', 'text': 'hello', 'description': 'è¾“å…¥æ–‡æœ¬'}
]
```

---

## ğŸ¨ Web é¡µé¢ç‰¹æ€§

### å®æ—¶æµå¼æ˜¾ç¤º
- Agent æ€è€ƒè¿‡ç¨‹å®æ—¶æ˜¾ç¤º
- ä»£ç ç”Ÿæˆé€å­—ç¬¦æµå¼è¾“å‡º
- è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹

### åŒæ å¸ƒå±€
- **å·¦ä¾§**ï¼šAgent æ‰§è¡Œæ—¥å¿—
- **å³ä¾§**ï¼šç”Ÿæˆçš„ä»£ç 

### äº¤äº’åŠŸèƒ½
- å¼€å§‹/åœæ­¢æ‰§è¡Œ
- å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿
- ä¸‹è½½ç”Ÿæˆçš„è„šæœ¬

### ç¾è§‚çš„ UI
- æ¸å˜è‰²ä¸»é¢˜
- å“åº”å¼è®¾è®¡
- å¹³æ»‘åŠ¨ç”»æ•ˆæœ

---

## ğŸ“Š äº‹ä»¶æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚
    â†“
POST /run-agent-stream
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 1: Agent æ‰§è¡Œ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ task_init                    â”‚
â”‚  â€¢ device_connected             â”‚
â”‚  â”œâ”€ step_start (æ­¥éª¤ 1)         â”‚
â”‚  â”œâ”€ screenshot                  â”‚
â”‚  â”œâ”€ llm_chunk (æ€è€ƒ...)         â”‚
â”‚  â”œâ”€ llm_complete                â”‚
â”‚  â”œâ”€ action_parsed               â”‚
â”‚  â”œâ”€ action_executing            â”‚
â”‚  â”œâ”€ action_completed            â”‚
â”‚  â””â”€ step_end                    â”‚
â”‚  â”œâ”€ step_start (æ­¥éª¤ 2)         â”‚
â”‚  â””â”€ ...                         â”‚
â”‚  â€¢ task_completed               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 2: ä»£ç ç”Ÿæˆ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ codegen_start                â”‚
â”‚  â€¢ codegen_chunk (auto();)      â”‚
â”‚  â€¢ codegen_chunk (function...)  â”‚
â”‚  â€¢ codegen_chunk (...)          â”‚
â”‚  â€¢ codegen_complete             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
  â€¢ done
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

æ‰€æœ‰äº‹ä»¶éƒ½ä¼šè®°å½•åˆ°æ—¥å¿—ä¸­ï¼š
```bash
tail -f logs/app.log
```

### 2. æµè§ˆå™¨å¼€å‘è€…å·¥å…·

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ï¼š
- ç½‘ç»œè¯·æ±‚
- SSE äº‹ä»¶æµ
- JavaScript é”™è¯¯

### 3. æ‰‹åŠ¨æµ‹è¯• API

ä½¿ç”¨ Postman æˆ– curl æµ‹è¯• SSE æ¥å£

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç‹¬ç«‹é…ç½®

ä»£ç ç”Ÿæˆå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„ API é…ç½®ï¼š
- `codegen_api_key`ï¼šä»£ç ç”Ÿæˆä¸“ç”¨ API Key
- `codegen_base_url`ï¼šä»£ç ç”Ÿæˆä¸“ç”¨ Base URL
- `codegen_model`ï¼šä»£ç ç”Ÿæˆä¸“ç”¨æ¨¡å‹

å¦‚æœä¸æä¾›ï¼Œå°†ä½¿ç”¨ Agent çš„é…ç½®ã€‚

### 2. å³ä½¿å¤±è´¥ä¹Ÿç”Ÿæˆ

å³ä½¿ Agent æ‰§è¡Œå¤±è´¥ï¼ˆstatus="error"ï¼‰ï¼Œä¹Ÿä¼šåŸºäºéƒ¨åˆ† history ç”Ÿæˆä»£ç ã€‚

### 3. History æ ¼å¼

ç¡®ä¿ `agent_core.py` ä¸­ä¿å­˜çš„æ˜¯å®Œæ•´çš„åŠ¨ä½œå¯¹è±¡ï¼Œè€Œéä»…æè¿°æ–‡æœ¬ã€‚

### 4. å¹¶å‘é™åˆ¶

æµå¼æ¥å£å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œä½†ç§»åŠ¨è®¾å¤‡åŒæ—¶åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚

---

## ğŸ¯ å®Œæ•´ç¤ºä¾‹

### å¯åŠ¨æœåŠ¡å¹¶æµ‹è¯•

1. **å¯åŠ¨æœåŠ¡**
```bash
python main.py
```

2. **æ‰“å¼€æµè§ˆå™¨**
```
http://localhost:9777/
```

3. **å¡«å†™é…ç½®**
- æŒ‡ä»¤ï¼š`æ‰“å¼€è®¾ç½®`
- API Keyï¼š`your-api-key`
- Base URLï¼š`http://your-api-url`

4. **ç‚¹å‡»å¼€å§‹æ‰§è¡Œ**

5. **è§‚å¯Ÿå®æ—¶è¾“å‡º**
- å·¦ä¾§æ˜¾ç¤º Agent æ‰§è¡Œè¿‡ç¨‹
- å³ä¾§æ˜¾ç¤ºç”Ÿæˆçš„ä»£ç 

6. **å®Œæˆåæ“ä½œ**
- ç‚¹å‡» **"ğŸ“‹ å¤åˆ¶"** å¤åˆ¶ä»£ç 
- ç‚¹å‡» **"ğŸ’¾ ä¸‹è½½"** ä¸‹è½½è„šæœ¬æ–‡ä»¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Agent Core æ–‡æ¡£](STREAM_AGENT_README.md)
- [æ—¥å¿—ç³»ç»Ÿæ–‡æ¡£](LOGGING_README.md)
- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](system_architecture.md)

---

## âœ… åŠŸèƒ½æ¸…å•

- [x] é€šç”¨ OpenAI å®¢æˆ·ç«¯æ¨¡å—
- [x] Auto.js ä»£ç ç”Ÿæˆå™¨
- [x] History å®Œæ•´å¯¹è±¡ä¿å­˜
- [x] SSE æµå¼æ¥å£
- [x] Web æ¼”ç¤ºé¡µé¢
- [x] å®æ—¶æµå¼æ˜¾ç¤º
- [x] ä»£ç å¤åˆ¶/ä¸‹è½½
- [x] é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- [x] ç‹¬ç«‹é…ç½®æ”¯æŒ
- [x] å“åº”å¼è®¾è®¡

---

## ğŸ‰ æ€»ç»“

æœ¬å®ç°æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„æµå¼ä»£ç ç”Ÿæˆæ–¹æ¡ˆï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
2. **æµå¼å“åº”**ï¼šå®æ—¶åé¦ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ
3. **çµæ´»é…ç½®**ï¼šæ”¯æŒç‹¬ç«‹çš„ä»£ç ç”Ÿæˆé…ç½®
4. **å®Œæ•´è®°å½•**ï¼šä¿å­˜å®Œæ•´çš„åŠ¨ä½œå¯¹è±¡ç”¨äºä»£ç ç”Ÿæˆ
5. **ç¾è§‚ç•Œé¢**ï¼šä¸“ä¸šçš„ Web æ¼”ç¤ºé¡µé¢
6. **æ˜“äºæ‰©å±•**ï¼šå¯è½»æ¾æ·»åŠ æ–°åŠŸèƒ½

ç°åœ¨æ‚¨å¯ä»¥é€šè¿‡ Web ç•Œé¢æˆ– API æ¥å£ï¼Œå®æ—¶è§‚çœ‹ Mobile Agent çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶è·å¾—ç”Ÿæˆçš„ Auto.js è‡ªåŠ¨åŒ–è„šæœ¬ï¼
